generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // IMPORTANT: keep `?schema=app` in DATABASE_URL to isolate tables from landing.
  url      = env("DATABASE_URL")
}

model User {
  id              String   @id @default(cuid())
  externalUserId  String?  @unique @map("external_user_id")
  email           String?  @unique(map: "app_users_email_key")
  emailVerified   DateTime? @map("email_verified")
  name            String?
  image           String?
  latestIpAddress String?  @map("latest_ip_address")
  latestUserAgent String?  @map("latest_user_agent")
  language        String?
  pageLanguage    String?  @map("page_language")
  referrer        String?
  fullUrl         String?  @map("full_url")
  queryParams     String?  @map("query_params")
  screenWidth     Int?     @map("screen_width")
  screenHeight    Int?     @map("screen_height")
  timezone        String?
  platform        String?
  pathname        String?
  totalUsageSec   Int      @default(0) @map("total_usage_sec")
  firstSeenAt     DateTime @default(now()) @map("first_seen_at")
  lastSeenAt      DateTime @default(now()) @map("last_seen_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  messages  AppMessage[]
  eventLogs AppEventLog[]
  versionPoliciesCreated AppClientVersionPolicy[]
  accounts  Account[]
  sessions  Session[]

  @@index([lastSeenAt], map: "app_users_last_seen_at_idx")
  @@map("app_users")
}

model AppMessage {
  id                          String   @id @default(cuid())
  userId                      String?  @map("user_id")
  sessionKey                  String?  @map("session_key")
  clientMessageId             String?  @map("client_message_id")
  sourceLanguage              String   @map("source_language")
  translationPromptTokens     Int?     @map("translation_prompt_tokens")
  translationCompletionTokens Int?     @map("translation_completion_tokens")
  translationTotalTokens      Int?     @map("translation_total_tokens")
  ttsInputTokens              Int?     @map("tts_input_tokens")
  ttsOutputTokens             Int?     @map("tts_output_tokens")
  ttsTotalTokens              Int?     @map("tts_total_tokens")
  sttDurationMs               Int?     @map("stt_duration_ms")
  totalDurationMs             Int?     @map("total_duration_ms")
  metadata                    Json?
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  user      User?               @relation(fields: [userId], references: [id], onDelete: SetNull)
  contents  AppMessageContent[]
  eventLogs AppEventLog[]

  @@unique([sessionKey, clientMessageId], map: "app_messages_session_client_message_uidx")
  @@index([userId, createdAt], map: "app_messages_user_created_at_idx")
  @@index([sessionKey, createdAt], map: "app_messages_session_created_at_idx")
  @@index([createdAt], map: "app_messages_created_at_idx")
  @@map("app_messages")
}

model AppMessageContent {
  id          String   @id @default(cuid())
  messageId   String   @map("message_id")
  contentType String   @map("content_type")
  language    String
  text        String   @db.Text
  provider    String?
  model       String?
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  message AppMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@unique([messageId, contentType, language], map: "app_message_contents_message_type_lang_uidx")
  @@index([messageId, createdAt], map: "app_message_contents_message_created_at_idx")
  @@index([contentType], map: "app_message_contents_type_idx")
  @@index([language], map: "app_message_contents_language_idx")
  @@map("app_message_contents")
}

model AppEventLog {
  id         String   @id @default(cuid())
  userId     String?  @map("user_id")
  messageId  String?  @map("message_id")
  sessionKey String?  @map("session_key")
  eventType  String   @map("event_type")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  platform   String?
  appVersion String?  @map("app_version")
  locale     String?
  fullUrl    String?  @map("full_url")
  pathname   String?
  usageSec   Int?     @map("usage_sec")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  user    User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  message AppMessage? @relation(fields: [messageId], references: [id], onDelete: SetNull)

  @@index([eventType], map: "app_event_logs_event_type_idx")
  @@index([createdAt], map: "app_event_logs_created_at_idx")
  @@index([userId], map: "app_event_logs_user_id_idx")
  @@index([sessionKey], map: "app_event_logs_session_key_idx")
  @@index([messageId], map: "app_event_logs_message_id_idx")
  @@map("app_event_logs")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId], map: "auth_accounts_provider_provider_account_id_key")
  @@index([userId], map: "auth_accounts_user_id_idx")
  @@map("auth_accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique(map: "auth_sessions_session_token_key") @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "auth_sessions_user_id_idx")
  @@map("auth_sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique(map: "auth_verification_tokens_token_key")
  expires    DateTime

  @@unique([identifier, token], map: "auth_verification_tokens_identifier_token_key")
  @@map("auth_verification_tokens")
}

model NativeAuthPendingResult {
  requestId  String   @id @map("request_id")
  status     String
  provider   String?
  callbackUrl String  @map("callback_url")
  bridgeToken String? @map("bridge_token")
  message    String?
  expiresAt  DateTime @map("expires_at")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@index([expiresAt], map: "native_auth_pending_results_expires_at_idx")
  @@map("native_auth_pending_results")
}

model AppClientVersion {
  id        String   @id @default(cuid())
  platform  String   @default("ios")
  version   String
  major     Int
  minor     Int
  patch     Int
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([platform, version], map: "app_client_versions_platform_version_key")
  @@index([platform, major, minor, patch], map: "app_client_versions_platform_semver_idx")
  @@index([createdAt], map: "app_client_versions_created_at_idx")
  @@map("app_client_versions")
}

model AppClientVersionPolicy {
  id                      String   @id @default(cuid())
  platform                String   @default("ios")
  effectiveFrom           DateTime @default(now()) @map("effective_from")
  minSupportedVersion     String   @map("min_supported_version")
  recommendedBelowVersion String?  @map("recommended_below_version")
  latestVersion           String?  @map("latest_version")
  updateUrl               String?  @map("update_url")
  note                    String?
  createdByUserId         String?  @map("created_by_user_id")
  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  createdByUser User? @relation(fields: [createdByUserId], references: [id], onDelete: SetNull)

  @@index([platform, effectiveFrom, createdAt], map: "app_client_version_policies_platform_effective_idx")
  @@index([createdByUserId], map: "app_client_version_policies_created_by_user_id_idx")
  @@index([createdAt], map: "app_client_version_policies_created_at_idx")
  @@map("app_client_version_policies")
}
